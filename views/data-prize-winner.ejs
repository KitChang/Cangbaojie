
      <div class="container content">
        <div class="row">

            <div class="panel panel-dashboard full-width">
                <ol class="breadcrumb panel-heading panel-heading-cbj">

                  <li><a href="/data/prize-winner">获奖人－请选广告</a></li>
                  <li>获奖人</li>
                </ol>  
                <div class="panel-body">
                    <form class="form-inline" action="/data/prize-winner" method="get">
                        <div class="panel-elem">
                            <div class="form-group">
                                <label>广告</label>
                                <select class="form-control" id="advertisement" name="advertisement">
                                    
                                <%
                                    var ad;
                                    if(adArr){
                                    while(adArr.length){
                                        ad = adArr.pop();
                                        if(req.param('advertisement')&&req.param('advertisement')==ad.id){
                                %>
                                    <option value="<%=ad.id%>" selected><%=ad.client.name%>-<%=ad.title%></option>
                                <%
                                        }else{
                                %>
                                    <option value="<%=ad.id%>" ><%=ad.client.name%>-<%=ad.title%></option>
                                <%
                                        }
                                    }
                                    }
                                %>

                                </select>
                            </div>
                            <div class="form-group">
                                <label>奖项</label>
                                <select class="form-control" name="prize">
                                    <%
                                    if(req.param('prize')&&req.param('prize')!=""){
                                    %>
                                    <option value="<%=req.param('prize')%>" selected><%=req.param('prize')%></option>
                                    <%
                                    }
                                    %>
                                    <option value="">所有奖项</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                                </div>
                            </div>
                            <div class="panel-elem">
                                <div class="form-group">
                                        <select class="form-control" id="locationType" name="locationType">
                                            <%
                                            if(req.param("locationType")&&req.param("locationType")!=""){
                                            %>
                                            <option value="<%=req.param('locationType')%>" selected><%=req.param('locationType')%></option>
                                            <%
                                            }
                                            %>
                                            <option value="">所有位置类</option>
                                            <option value="公交站">公交站</option>
                                            <option value="公交车">公交车</option>
                                            <option value="电梯">电梯</option>
                                            <option value="路名牌">路名牌</option>
                                        </select>
                                </div>
                                <div class="form-group">
                                    <select class="form-control" id="state" name="state">
                                        <%
                                        if(req.param("state")&&req.param("state")!=""){
                                        %>
                                        <option value="<%=req.param('state')%>" selected><%=req.param('state')%></option>

                                        <%
                                        }
                                        %>
                                        <option value="">所有省</option>
                                        <option value="广东省">广东省</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <select class="form-control" id="city" name="city">
                                        <%
                                        if(req.param("city")&&req.param("city")!=""){
                                        %>
                                        <option value="<%=req.param('city')%>" selected><%=req.param('city')%></option>
                                        <%
                                        }
                                        %>

                                    </select>
                                </div>
                                <div class="form-group">
                                    <select class="form-control" id="region" name="region">
                                        <%
                                        if(req.param("region")&&req.param("region")!=""){
                                        %>
                                        <option value="<%=req.param('region')%>" selected><%=req.param('region')%></option>
                                        <%
                                        }
                                        %>

                                    </select>
                                </div>
                                <div class="form-group">
                                    <select class="form-control" id="street" name="street">
                                         <%
                                        if(req.param("street")&&req.param("street")!=""){
                                        %>
                                        <option value="<%=req.param('street')%>" selected><%=req.param('street')%></option>
                                        <%
                                        }
                                        %>

                                    </select>
                                </div>
                        </div>
                            
                        
                        
                        <button type="submit" class="btn btn-warning">搜索</button>
                    </form>
                </div>
                <div class="panel-body">
                <table class="table table-strip" id="table">
                    <thead>
                    <tr><th>日期</th><th>用户名</th><th>用户联系</th><th>奖项</th><th>领奖</th><th>截止日期</th><th>有效</th></tr>
                    </thead>
                    <tbody>
                    <%
                    if(resultArr!=null)
                    while(resultArr.length){
                        var row = resultArr.pop();
                        var date = row.createdAt;
                        var date2 = moment(date).format("YYYY-MM-DD HH:mm:ss");
                        var phone = "wechat用戶";
                        var prizeStr = ["", "一等奖", "二等奖", "三等奖", "四等奖", "五等奖"];
                        if (row.appUser.authType == "local") {
                            phone = row.appUser.phone;
                        }
                        var pickStatus = row.picked;
                        if(pickStatus==true)
                            pickStatus = "已领";
                        else
                            pickStatus = "未领";
                        var expiredDate = row.prizeCouponExpiredAt;
                        expiredDateStr = moment(expiredDate).format("MM/DD/YYYY HH:mm:ss");
                        var expired = !moment().isBefore(expiredDate);
                        if(expired)
                            expired = "过期";
                        else
                            expired = "未过期";
                        var prize = prizeStr[row.prize];
                    %>
                    <tr><td><%=date2%></td><td><%=row.appUser.username%></td><td><%=phone%></td><td><%=prize%></td><td><%=pickStatus%></td><td><%=expiredDateStr%></td><td><%=expired%></td></tr>
                    <%
                    }
                    %>
                    </tbody>
                </table>
                </div>
            </div>
        </div>
        
      </div>
    


    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script type="text/javascript" src="/js/dependencies/jquery.min.js"></script>
    <script type="text/javascript" src="/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="//cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
    <script>
        
        $(document).ready(function(){
            populateCity();
            populateRegion();
            populateStreet();
            $("#table").DataTable(
            {
                "language": 
                {"url": "//cdn.datatables.net/plug-ins/1.10.10/i18n/Chinese.json"},
                "order": [[ 0, "desc" ]]
            });
            function populateCity(){
            var selectedState = $("#state option:selected").text();

            $.ajax({
            url: "/geo/city?state="+selectedState
            }).done(function(data){
                console.log("city");
              $("#city").append("<option value=''>所有城市</option>");
              html = "";
              while (data.length) {
                var city = data.pop();
                option = "<option value='"+city+"'>"+city+"</option>";
                html = html + option;
                //code
              }
              $("#city").append(html);
              }).error(function(err){
                console.log("all city");
              $("#city").append("<option value=''>所有城市</option>");
              });
            }
            function populateRegion(){
            var selectedState = $("#state option:selected").text();
            var selectedCity = $("#city option:selected").text();
            if(selectedCity=="所有城市"||selectedCity==""){
                $("#region").append("<option value=''>所有地区</option>");
            }
            $.ajax({
            url: "/geo/region?state="+selectedState+"&city="+selectedCity,
            }).done(function(data){
              //alert(data);
              $("#region").append("<option value=''>所有地区</option>");
              html = "";
              while (data.length) {
                var region = data.pop();
                option = "<option value='"+region+"'>"+region+"</option>";
                html = html + option;
                //code
              }
              $("#region").append(html);
              });
            }

            function populateStreet(){
                var selectedState = $("#state option:selected").text();
                var selectedCity = $("#city option:selected").text();
                var selectedRegion = $("#region option:selected").text();
                if(selectedRegion=="所有地区"||selectedRegion=="")
                    $("#street").append("<option value=''>所有街道</option>");;

                $.ajax({
                url: "/geo/street?state="+selectedState+"&city="+selectedCity+"&region="+selectedRegion,
                }).done(function(data){
                  //alert(data);
                  $("#street").append("<option value=''>所有街道</option>");
                  html = "";
                  while (data.length) {
                    var street = data.pop();
                    option = "<option value='"+street+"'>"+street+"</option>";
                    html = html + option;
                    //code
                  }
                  $("#street").append(html);
                });
            }


            $("#state").change(function(){
                $("#city").empty();
                $("#region").empty();
                $("#region").append("<option value=''>所有地区</option>");
                $("#street").empty();
                $("#street").append("<option value=''>所有街道</option>");
                populateCity();
            });
            $("#city").change(function(){
                $("#region").empty();
                $("#street").empty();
                $("#street").append("<option value=''>所有街道</option>");
                populateRegion();
            });
            $("#region").change(function(){
                $("#street").empty();
                populateStreet();
            });
    
            
            
            
            
            
        });
        
    </script>
